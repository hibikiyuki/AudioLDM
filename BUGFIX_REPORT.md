# ğŸ”§ AudioLDM-IEC éŸ³å£°ç”Ÿæˆå•é¡Œã®ä¿®æ­£å ±å‘Š

## ğŸ“‹ å•é¡Œã®æ¦‚è¦

IECæ©Ÿèƒ½ã§ç”Ÿæˆã•ã‚ŒãŸéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã®å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã—ãŸï¼š

1. **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºç•°å¸¸**: 65KBç¨‹åº¦ï¼ˆæ­£å¸¸: 160KBç¨‹åº¦ï¼‰
2. **ãƒãƒ£ãƒ³ãƒãƒ«æ•°ç•°å¸¸**: 64ãƒãƒ£ãƒ³ãƒãƒ«ï¼ˆæ­£å¸¸: 1ãƒãƒ£ãƒ³ãƒãƒ«/ãƒ¢ãƒãƒ©ãƒ«ï¼‰
3. **å†ç”Ÿä¸å¯**: æ¨™æº–ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ
4. **ãƒ‡ãƒ¼ã‚¿å½¢çŠ¶ç•°å¸¸**: (512, 64) â†’ 512ã‚µãƒ³ãƒ—ãƒ«Ã—64ãƒãƒ£ãƒ³ãƒãƒ«

## ğŸ” åŸå› åˆ†æ

### æ ¹æœ¬åŸå› 
AudioLDMã®å†…éƒ¨API

ã®èª¤è§£ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸï¼š

1. **`decode_first_stage`ã®èª¤ç”¨**
   - `decode_first_stage()` ã¯ãƒ¡ãƒ«ã‚¹ãƒšã‚¯ãƒˆãƒ­ã‚°ãƒ©ãƒ ã‚’è¿”ã™ã ã‘
   - éŸ³å£°æ³¢å½¢ã«å¤‰æ›ã™ã‚‹ã«ã¯ `mel_spectrogram_to_waveform()` ãŒå¿…è¦

2. **ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¤ã‚ºæ³¨å…¥ã®å¤±æ•—**
   - ç‹¬è‡ªã®æ½œåœ¨ãƒã‚¤ã‚º `x_T` ã‚’æä¾›ã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒä¸é©åˆ‡
   - AudioLDMã® `generate_sample` ã¯ `x_T=None` ã‚’æœŸå¾…
   - ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¤ã‚ºã¯å†…éƒ¨ã®å½¢çŠ¶æ¤œè¨¼ã§ã‚¨ãƒ©ãƒ¼

3. **æ½œåœ¨ç©ºé–“ã‚µã‚¤ã‚ºã®ä¸ä¸€è‡´**
   - æ‰‹å‹•è¨ˆç®—ã—ãŸ `latent_shape` ãŒä¸æ­£ç¢º
   - duration=3.0ç§’ãŒ2.5ç§’ã®å€æ•°ã§ã¯ãªã„ãŸã‚ã€å†…éƒ¨ã§ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã‚‹

## âœ… ä¿®æ­£å†…å®¹

### 1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å¤‰æ›´

**Beforeï¼ˆèª¤ã‚Šï¼‰:**
```python
# æ½œåœ¨ãƒã‚¤ã‚ºã‚’éºä¼å­ã¨ã—ã¦ä¿æŒ
genotype.latent_noise = torch.randn(latent_shape)

# ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¤ã‚ºã§ç”Ÿæˆ
samples, _ = sampler.sample(x_T=latent_noise, ...)
waveform = decode_first_stage(samples)  # âŒ ãƒ¡ãƒ«ã‚¹ãƒšã‚¯ãƒˆãƒ­ã‚°ãƒ©ãƒ ãŒè¿”ã‚‹
```

**Afterï¼ˆæ­£è§£ï¼‰:**
```python
# ã‚·ãƒ¼ãƒ‰å€¤ã‚’éºä¼å­ã¨ã—ã¦ä¿æŒ
genotype.seed = random_seed

# æ¨™æº–APIã§ç”Ÿæˆ
seed_everything(genotype.seed)
waveform = text_to_audio(
    latent_diffusion, text, seed=seed, ...
)  # âœ… æ­£ã—ã„éŸ³å£°æ³¢å½¢ãŒè¿”ã‚‹
```

### 2. ä¸»ãªå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«

#### `audioldm/iec_pipeline.py`
- **éºä¼å­è¡¨ç¾ã®å¤‰æ›´**: æ½œåœ¨ãƒã‚¤ã‚º â†’ ã‚·ãƒ¼ãƒ‰å€¤
- **éŸ³å£°ç”Ÿæˆã®å¤‰æ›´**: ã‚«ã‚¹ã‚¿ãƒ ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚° â†’ æ¨™æº– `text_to_audio()`
- **åˆæœŸåŒ–ã®ç°¡ç•¥åŒ–**: `DDIMSampler` ã‚„ `latent_shape` ã®å‰Šé™¤
- **é€²åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®èª¿æ•´**: ã‚·ãƒ¼ãƒ‰ã®ç·šå½¢è£œé–“

```python
# ã‚·ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®éºä¼å­å‹
genotype = AudioGenotype(
    latent_noise=torch.zeros(1),  # ãƒ€ãƒŸãƒ¼ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
    seed=random_seed,
    metadata={"prompt": prompt}
)

# æ¨™æº–APIã§éŸ³å£°ç”Ÿæˆ
waveform = text_to_audio(
    self.latent_diffusion,
    text=prompt,
    seed=genotype.seed,
    duration=self.duration,
    ddim_steps=self.ddim_steps,
    guidance_scale=self.guidance_scale
)
```

#### `audioldm/iec_gradio.py`
- **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«å¤‰æ›´**: `audioldm-s-full` â†’ `audioldm-s-full-v2`

#### ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ›´æ–°
- `scripts/launch_iec_gradio.py`
- `scripts/run_iec_cli.py`
- ã™ã¹ã¦ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ã‚’ `audioldm-s-full-v2` ã«çµ±ä¸€

### 3. éŸ³å£°ä¿å­˜ã®æ”¹å–„

```python
# waveformã®å½¢çŠ¶ã«å¿œã˜ãŸæŸ”è»Ÿãªå‡¦ç†
if len(waveform.shape) == 3:
    audio_data = waveform[0, 0, :]  # (batch, channels, samples)
elif len(waveform.shape) == 2:
    audio_data = waveform[0, :]     # (batch, samples)
else:
    audio_data = waveform            # (samples,)

sf.write(filepath, audio_data, samplerate=16000)
```

## ğŸ§ª æ¤œè¨¼çµæœ

### Before (å•é¡Œã‚ã‚Š)
```bash
$ file gen000_ind00.wav
RIFF, WAVE audio, 16 bit, 64 channels 16000 Hz  # âŒ 64ãƒãƒ£ãƒ³ãƒãƒ«

$ ls -lh gen000_ind00.wav
65K gen000_ind00.wav  # âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºå°ã•ã„

$ python -c "import soundfile as sf; print(sf.read('gen000_ind00.wav')[0].shape)"
(512, 64)  # âŒ 512ã‚µãƒ³ãƒ—ãƒ«Ã—64ãƒãƒ£ãƒ³ãƒãƒ«
```

### After (ä¿®æ­£å¾Œ)
```bash
$ file test_gen000_ind00.wav
RIFF, WAVE audio, Microsoft PCM, 16 bit, mono 16000 Hz  # âœ… ãƒ¢ãƒãƒ©ãƒ«

$ ls -lh test_gen000_ind00.wav
161K test_gen000_ind00.wav  # âœ… æ­£å¸¸ãªã‚µã‚¤ã‚º

$ python -c "import soundfile as sf; print(sf.read('test_gen000_ind00.wav')[0].shape)"
(81952,)  # âœ… ç´„5ç§’åˆ†ã®ã‚µãƒ³ãƒ—ãƒ« (81952 / 16000 â‰ˆ 5.12ç§’)
```

### ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®çµæœ
```
âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ
âœ… åˆæœŸåŒ–æˆåŠŸ
âœ… ç”ŸæˆæˆåŠŸ: 2å€‹ã®å€‹ä½“
   å€‹ä½“0: æ³¢å½¢å½¢çŠ¶=(1, 1, 81952), dtype=float32
   âœ… æ­£ã—ã„å½¢çŠ¶ (batch, channels, samples)
âœ… ä¿å­˜æˆåŠŸ: 2å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«
   test_gen000_ind00.wav: 160.1 KB
   èª­ã¿è¾¼ã¿æˆåŠŸ: å½¢çŠ¶=(81952,), SR=16000Hz
   âœ… ãƒ¢ãƒãƒ©ãƒ«éŸ³å£°
   âœ… é•·ã•OK (81952 ã‚µãƒ³ãƒ—ãƒ«)
   âœ… ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºOK
âœ… é€²åŒ–æˆåŠŸ: 2å€‹ã®æ¬¡ä¸–ä»£å€‹ä½“
âœ… å±¥æ­´ä¿å­˜æˆåŠŸ

âœ… å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼
```

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ

| é …ç›® | Before | After |
|------|--------|-------|
| **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º** | 65 KB | 161 KB |
| **ãƒãƒ£ãƒ³ãƒãƒ«æ•°** | 64 | 1 (mono) |
| **ã‚µãƒ³ãƒ—ãƒ«æ•°** | 512 | 81,952 |
| **éŸ³å£°é•·** | 0.032ç§’ | 5.12ç§’ |
| **å†ç”Ÿå¯å¦** | âŒ | âœ… |
| **ç”Ÿæˆæ™‚é–“/å€‹ä½“** | - | ~2ç§’ |

## ğŸ¯ è¿½åŠ ã®æ”¹å–„ç‚¹

### 1. durationåˆ¶ç´„ã®æ˜ç¢ºåŒ–
AudioLDMã¯ **2.5ç§’ã®å€æ•°** ã§ã—ã‹å‹•ä½œã—ã¾ã›ã‚“ï¼š
- æœ‰åŠ¹ãªå€¤: 2.5, 5.0, 7.5, 10.0, ...
- ç„¡åŠ¹ãªå€¤: 3.0, 4.0, 6.0, ...ï¼ˆã‚¨ãƒ©ãƒ¼ç™ºç”Ÿï¼‰

```python
def round_up_duration(duration):
    return int(round(duration/2.5) + 1) * 2.5
```

### 2. ã‚·ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®é€²åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

**äº¤å‰ï¼ˆCrossoverï¼‰:**
```python
# 2ã¤ã®è¦ªã®ã‚·ãƒ¼ãƒ‰ã‚’ç·šå½¢è£œé–“
parent1_seed, parent2_seed = selected_parents
alpha = random.uniform(0.3, 0.7)
child_seed = int(parent1_seed * alpha + parent2_seed * (1 - alpha))
```

**çªç„¶å¤‰ç•°ï¼ˆMutationï¼‰:**
```python
# ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ¼ãƒ‰ã¨æ··åˆ
if random.random() < mutation_rate:
    random_seed = random.randint(0, 2**31 - 1)
    child_seed = int(child_seed * 0.7 + random_seed * 0.3)
```

### 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–
- ã‚·ãƒ¼ãƒ‰å€¤ã®ç¯„å›²ãƒã‚§ãƒƒã‚¯ (0 ~ 2^31-1)
- durationã®2.5ç§’å€æ•°ãƒã‚§ãƒƒã‚¯
- waveformå½¢çŠ¶ã®æŸ”è»Ÿãªå‡¦ç†

## ğŸ“ ä»Šå¾Œã®æ³¨æ„äº‹é …

1. **ãƒ¢ãƒ‡ãƒ«æŒ‡å®š**: å¿…ãš `audioldm-s-full-v2` ã‚’ä½¿ç”¨
2. **duration**: 2.5ç§’ã®å€æ•°ã‚’æŒ‡å®š (æ¨å¥¨: 5.0ç§’)
3. **ã‚·ãƒ¼ãƒ‰å†ç¾æ€§**: åŒã˜ã‚·ãƒ¼ãƒ‰ã§åŒã˜éŸ³å£°ãŒç”Ÿæˆã•ã‚Œã‚‹
4. **GPUãƒ¡ãƒ¢ãƒª**: population_size Ã— duration ã«æ¯”ä¾‹

## ğŸš€ ä½¿ç”¨æ–¹æ³•

```bash
# ä¿®æ­£å¾Œã®ã‚·ã‚¹ãƒ†ãƒ ã‚’ãƒ†ã‚¹ãƒˆ
python scripts/test_audio_generation.py

# Gradio UIã‚’èµ·å‹•
python scripts/launch_iec_gradio.py

# CLIç‰ˆã‚’å®Ÿè¡Œ
python scripts/run_iec_cli.py --prompt "çˆ†ç™ºéŸ³" --population_size 6 --duration 5.0
```

## âœ… çµè«–

éŸ³å£°ç”Ÿæˆã®å•é¡Œã¯å®Œå…¨ã«è§£æ±ºã•ã‚Œã¾ã—ãŸï¼š
- âœ… æ­£ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º (160KBç¨‹åº¦)
- âœ… ãƒ¢ãƒãƒ©ãƒ«éŸ³å£° (1ãƒãƒ£ãƒ³ãƒãƒ«)
- âœ… æ¨™æº–ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã§å†ç”Ÿå¯èƒ½
- âœ… æ­£ã—ã„éŸ³å£°é•· (æŒ‡å®šã—ãŸç§’æ•°)
- âœ… å…¨ãƒ†ã‚¹ãƒˆãƒ‘ã‚¹

ã‚·ã‚¹ãƒ†ãƒ ã¯ç ”ç©¶å®Ÿé¨“ã‚’é–‹å§‹ã§ãã‚‹çŠ¶æ…‹ã§ã™ã€‚

---

ä¿®æ­£æ—¥: 2026å¹´1æœˆ8æ—¥  
ä¿®æ­£è€…: AI Assistant  
ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.1.0
